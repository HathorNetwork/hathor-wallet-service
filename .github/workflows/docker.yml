name: docker
on:
  push:
    tags:
      - v*
    branches:
      - master
      - 'experimental/**'
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare tags
      id: tags
      shell: python
      run: |
        import datetime
        import os
        import re

        timestamp = str(int(datetime.datetime.now().timestamp()))
        base_dockerhub_tag = 'docker.io/hathornetwork/hathor-wallet-service-sync-daemon:'
        aws_ecr_url = '${{ secrets.AWS_ECR_URL }}'
        base_ecr_tag = f'{aws_ecr_url}:' if aws_ecr_url else None

        version_regex = re.compile(r'^v(\d+)\.(\d+)\.(\d+)')
        rc_regex = re.compile(r'^rc(\.?)[0-9]{1,3}$')

        tags = set()
        build_target = 'prod'
        version = ''
        ref = '${{ github.ref }}'
        sha = '${{ github.sha }}'

        if ref.startswith('refs/tags/'):
            git_tag = ref[10:]
            tag_version, _, part = git_tag.partition('-')

            if version_regex.match(tag_version):
                if rc_regex.match(part):
                    version = git_tag
                    tags.add(base_dockerhub_tag + git_tag)
                    if base_ecr_tag:
                        tags.add(base_ecr_tag + git_tag)
                else:
                    version = tag_version
                    tags.add(base_dockerhub_tag + tag_version)
                    tags.add(base_dockerhub_tag + f'{sha}-{timestamp}')
                    tags.add(base_dockerhub_tag + 'latest')
                    if base_ecr_tag:
                        tags.add(base_ecr_tag + tag_version)
                        tags.add(base_ecr_tag + f'{sha}-{timestamp}')
                        tags.add(base_ecr_tag + 'latest')

        elif ref == 'refs/heads/master':
            version = 'stable'
            tags.add(base_dockerhub_tag + 'stable')
            tags.add(base_dockerhub_tag + f'sha-{sha[:8]}')
            if base_ecr_tag:
                tags.add(base_ecr_tag + 'stable')
                tags.add(base_ecr_tag + f'sha-{sha[:8]}')

        elif ref.startswith('refs/heads/experimental/'):
            branch = ref[24:].replace('/', '-')
            version = f'experimental-{branch}'
            tags.add(base_dockerhub_tag + f'experimental-{branch}-{sha[:8]}-{timestamp}')
            if base_ecr_tag:
                tags.add(base_ecr_tag + f'experimental-{branch}-{sha[:8]}-{timestamp}')
            build_target = 'dev'

        created = datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')

        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'tags={",".join(tags)}\n')
            f.write(f'build_target={build_target}\n')
            f.write(f'version={version}\n')
            f.write(f'created={created}\n')
            f.write(f'login_dockerhub={"true" if tags else "false"}\n')
            f.write(f'login_ecr={"true" if aws_ecr_url and tags else "false"}\n')

    - name: Prepare build context
      run: |
        # Copy the daemon's .dockerignore to the root for the build
        cp packages/daemon/.dockerignore .dockerignore

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      if: steps.tags.outputs.login_dockerhub == 'true'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Login to AWS ECR
      if: steps.tags.outputs.login_ecr == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.AWS_ECR_URL }}
        username: ${{ secrets.AWS_ACCESS_KEY_ID }}
        password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Build and push
      if: steps.tags.outputs.tags != ''
      uses: docker/build-push-action@v6
      with:
        context: .
        file: packages/daemon/Dockerfile
        target: ${{ steps.tags.outputs.build_target }}
        pull: true
        push: true
        tags: ${{ steps.tags.outputs.tags }}
        platforms: linux/amd64,linux/arm64
        labels: |
          org.opencontainers.image.title=${{ github.event.repository.name }}
          org.opencontainers.image.description=${{ github.event.repository.description }}
          org.opencontainers.image.url=${{ github.event.repository.html_url }}
          org.opencontainers.image.source=${{ github.event.repository.clone_url }}
          org.opencontainers.image.version=${{ steps.tags.outputs.version }}
          org.opencontainers.image.created=${{ steps.tags.outputs.created }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.licenses=${{ github.event.repository.license.spdx_id }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
